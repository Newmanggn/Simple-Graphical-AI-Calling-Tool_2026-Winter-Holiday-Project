# 自定义模块开发说明文档

## 1. 概述

本文档旨在指导开发者如何为图形化AI调用工具创建自定义模块。自定义模块可以扩展工具的功能，实现特定的业务逻辑，或者集成第三方服务。

## 2. 模块结构

一个完整的自定义模块由以下部分组成：

### 2.1 配置头部

模块文件的开头需要包含一系列以 `#` 开头的配置参数，这些参数定义了模块的基本属性和行为。

```python
#input_quantity=001      # 输入端口数量
#variable_quantity=001    # 变量数量
#userinput=false          # 是否支持用户输入
#setting=false            # 是否支持设置
#output_quantity=001      # 输出端口数量
#time_late=000            # 延迟时间
#name=缓存模块            # 模块名称
#excitedbydata=true        # 是否可被数据激活
#variables_name=input      # 变量名称（多个变量用逗号分隔）
#kind=处理模块            # 模块类型
#output_name=output        # 输出名称（多个输出用逗号分隔）
```

### 2.2 模块代码

配置头部之后是模块的实际代码，包括：

1. 必要的导入语句
2. 模块的核心逻辑函数
3. 主执行函数 `execute()`
4. 可选的测试代码

## 3. 配置参数详细说明

| 参数 | 说明 | 示例值 |
|------|------|--------|
| input_quantity | 输入端口数量，格式为三位数字 | 001, 004 |
| variable_quantity | 变量数量，格式为三位数字 | 001, 004 |
| userinput | 是否支持用户输入，T/F | T, F |
| setting | 是否支持设置，T/F | T, F |
| output_quantity | 输出端口数量，格式为三位数字 | 001, 002 |
| time_late | 延迟时间 | 0, 1000 |
| excitedbydata | 是否可被数据激活，T/F | T, F |
| name | 模块名称 | 缓存模块, 调用模块 |
| kind | 模块类型 | 处理模块, 调用模块 |
| variables_name | 变量名称，多个用逗号分隔 | 模型选择,提示词,上下文,对话 |
| output_name | 输出名称，多个用逗号分隔 | 生成结果,更新后的上下文 |

## 4. 执行函数格式

每个模块必须实现一个 `execute()` 函数，这是模块的主入口点。函数的参数数量应与模块的输入端口数量匹配。

### 4.1 基本格式

```python
def execute(input1, input2, ..., settings=None, cancel_token=None):
    """
    执行模块逻辑
    
    参数:
    - input1, input2, ...: 输入参数，数量与input_quantity对应
    - settings: 额外的设置参数（可选）
    - cancel_token: 取消令牌函数，用于检查是否需要取消执行（可选，主要用于调用模块）
    
    返回:
    - 输出值或输出值列表，数量与output_quantity对应
    """
    # 模块逻辑
    # ...
    
    # 返回结果
    return output
    # 或多个返回值
    # return output1, output2
```

### 4.2 示例

#### 缓存模块示例

```python
def execute(input_data):
    """
    执行缓存逻辑
    :param input_data: 输入数据
    :return: 缓存的数据
    """
    global _cache
    
    # 如果输入数据不是None，则更新缓存
    if input_data is not None:
        _cache = input_data
    
    # 返回缓存的数据
    return _cache
```

**注意**：在图形化界面中，缓存模块和显示模块会使用`displayContent`变量来存储和显示内容。这个变量与实际输出值分离，确保停止运行时显示内容不会被清空。当模块有新的输入数据时，`displayContent`会被更新为新的内容；当停止运行时，`displayContent`变量会被保留，而其他端口变量会被清空。

#### 调用模块示例

```python
def execute(model_params, prompt_params, context_params, dialogue_params, settings=None):
    """
    执行模块逻辑
    
    参数:
    - model_params: 模型选择（包含模型选择等）
    - prompt_params: 提示词参数
    - context_params: 上下文参数（包含对话上下文）
    - dialogue_params: 对话参数（包含用户提交给大模型的内容）
    - settings: 额外的设置参数（从前端传递的完整设置）
    
    返回:
    - 生成结果（包含更新后的上下文和本次生成结果）
    """
    # 模块逻辑
    # ...
    
    # 返回两个值，分别对应两个输出端口
    return result, updated_context
```

## 5. 模块类型

根据 `kind` 参数，模块可以分为以下类型：

| 类型 | 说明 | 示例 |
|------|------|------|
| 处理模块 | 对输入数据进行处理并输出结果 | 缓存模块, 比大小模块 |
| 调用模块 | 调用外部服务或API | 调用模块 |
| 输入模块 | 提供用户输入功能 | user输入模块 |
| 输出模块 | 展示输出结果 | 对话输出模块 |

## 6. 输入输出处理

### 6.1 输入处理

- 输入参数可以是任何类型的数据，包括字符串、数字、列表、字典等
- 模块应能处理 `None` 输入的情况
- 对于字符串类型的参数，可能需要进行类型转换

### 6.2 输出处理

- 输出可以是单个值或多个值（元组）
- 输出值的数量应与 `output_quantity` 配置一致
- 输出值的类型应与模块的功能相符

## 7. 设置配置

如果模块配置了 `setting=T`，则可以在图形化界面中显示设置选项。设置参数会通过 `execute()` 函数的 `settings` 参数传递给模块。

## 8. 模块开发最佳实践

1. **清晰的文档**: 为模块和关键函数添加详细的文档字符串
2. **错误处理**: 实现适当的错误处理，确保模块在异常情况下能够优雅失败
3. **类型检查**: 对输入参数进行类型检查，确保模块的健壮性
4. **默认值**: 为可选参数提供合理的默认值
5. **测试代码**: 添加测试代码，方便模块的调试和验证
6. **模块化**: 将复杂逻辑分解为多个函数，提高代码的可读性和可维护性

## 9. 模块测试

### 9.1 本地测试

在模块文件末尾添加测试代码，例如：

```python
# 模块入口
if __name__ == "__main__":
    # 测试模块
    test_data = "测试数据"
    result = execute(test_data)
    print(f"模块测试结果: {result}")
```

### 9.2 集成测试

将模块文件复制到 `default_modules` 目录，然后在图形化界面中添加并测试该模块。

## 10. 示例模块

### 10.1 简单的加法模块

```python
#input_quantity=002
#variable_quantity=002
#userinput=F
#setting=F
#output_quantity=001
#time_late=0
#excitedbydata=T
#name=加法模块
#kind=处理模块
#variables_name=数字1,数字2
#output_name=和

def execute(num1, num2):
    """
    执行加法操作
    
    参数:
    - num1: 第一个数字
    - num2: 第二个数字
    
    返回:
    - 两个数字的和
    """
    try:
        # 类型转换
        num1 = float(num1) if num1 is not None else 0
        num2 = float(num2) if num2 is not None else 0
        
        # 执行加法
        result = num1 + num2
        
        return result
    except Exception as e:
        # 错误处理
        return f"计算错误: {str(e)}"

# 测试代码
if __name__ == "__main__":
    test_result = execute(10, 20)
    print(f"加法测试结果: {test_result}")
    
    test_result2 = execute("30", "40")
    print(f"字符串加法测试结果: {test_result2}")
```

### 10.2 文本处理模块

```python
#input_quantity=001
#variable_quantity=001
#userinput=F
#setting=F
#output_quantity=001
#time_late=0
#excitedbydata=T
#name=文本转大写
#kind=处理模块
#variables_name=文本
#output_name=大写文本

def execute(text):
    """
    将文本转换为大写
    
    参数:
    - text: 输入文本
    
    返回:
    - 大写文本
    """
    if text is None:
        return ""
    
    try:
        # 确保输入是字符串
        if not isinstance(text, str):
            text = str(text)
        
        # 转换为大写
        return text.upper()
    except Exception as e:
        return f"处理错误: {str(e)}"

# 测试代码
if __name__ == "__main__":
    test_result = execute("hello world")
    print(f"文本转大写测试结果: {test_result}")
```

## 11. 模块部署

1. 将开发完成的模块文件保存为 `.py` 文件
2. 将文件复制到 `default_modules` 目录
3. 重启图形化AI调用工具
4. 在工具中添加新模块并测试

## 12. 故障排除

### 12.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 模块不显示在工具中 | 配置头部格式错误 | 检查配置头部的格式和参数 |
| 模块执行出错 | `execute()` 函数签名错误 | 确保 `execute()` 函数的参数数量与 `input_quantity` 一致 |
| 设置不生效 | 未处理 `settings` 参数 | 在 `execute()` 函数中添加对 `settings` 参数的处理 |
| 输出与预期不符 | 输出值数量与 `output_quantity` 不一致 | 确保返回值的数量与 `output_quantity` 配置一致 |

### 12.2 调试技巧

1. 在模块中添加 `print()` 语句，输出关键变量的值
2. 使用 `try-except` 块捕获并打印异常信息
3. 在图形化界面中查看模块的执行日志
4. 确保模块文件的编码格式为 UTF-8

## 13. 总结

自定义模块是扩展图形化AI调用工具功能的重要方式。通过遵循本文档的指导，开发者可以创建功能强大、可靠的自定义模块，满足特定的业务需求。

希望本文档能够帮助您顺利开发自定义模块！如果您有任何问题或建议，请随时反馈。
